# Data Model: Integrated RAG Chatbot for Docusaurus Book

## Entity: Document Chunk

**Description**: Represents a segment of book content with associated metadata and embeddings for vector search

**Fields**:
- `chunk_id`: UUID (Primary Key) - Unique identifier for the chunk
- `document_id`: String - Reference to the source document
- `module`: String - Module identifier (e.g., "Module 1: ROS 2 Foundations")
- `chapter`: String - Chapter identifier within the module
- `section`: String - Section title or heading
- `content`: Text - The actual text content of the chunk
- `embedding`: Vector - Qwen embedding vector for similarity search
- `position`: Integer - Sequential position within the document
- `metadata`: JSON - Additional metadata (authors, tags, etc.)
- `created_at`: DateTime - Timestamp of creation
- `updated_at`: DateTime - Timestamp of last update

**Validation Rules**:
- `content` must be 50-800 tokens in length
- `embedding` must be a valid Qwen embedding vector
- `module` and `chapter` must match existing book structure
- `document_id` must reference a valid document

## Entity: User Query

**Description**: Represents a question submitted by the reader with context information

**Fields**:
- `query_id`: UUID (Primary Key) - Unique identifier for the query
- `question`: Text - The user's question
- `mode`: Enum (book|selection) - Query mode (Book Mode or Selection Mode)
- `selected_text`: Text (Optional) - Text selected by user in Selection Mode
- `session_id`: String - Session identifier for conversation history
- `user_id`: String (Optional) - User identifier if authenticated
- `created_at`: DateTime - Timestamp of query submission
- `processed_at`: DateTime (Optional) - Timestamp when processed

**Validation Rules**:
- `question` must be 10-500 characters in length
- `mode` must be either 'book' or 'selection'
- If `mode` is 'selection', `selected_text` must not be empty
- `selected_text` must be 10-2000 characters in length

## Entity: Search Result

**Description**: Represents relevant document chunks retrieved from vector search with similarity scores

**Fields**:
- `result_id`: UUID (Primary Key) - Unique identifier for the result
- `query_id`: UUID (Foreign Key) - Reference to the original query
- `chunk_id`: UUID (Foreign Key) - Reference to the document chunk
- `similarity_score`: Float - Cosine similarity score (0.0-1.0)
- `rank`: Integer - Ranking position in search results
- `created_at`: DateTime - Timestamp of result creation

**Validation Rules**:
- `similarity_score` must be between 0.0 and 1.0
- `rank` must be a positive integer
- `chunk_id` must reference an existing document chunk

## Entity: Response

**Description**: Represents the final answer generated by the LLM with source citations and confidence indicators

**Fields**:
- `response_id`: UUID (Primary Key) - Unique identifier for the response
- `query_id`: UUID (Foreign Key) - Reference to the original query
- `answer`: Text - The generated answer text
- `citations`: JSON Array - List of source citations with module/chapter references
- `confidence_score`: Float - Confidence level in the response (0.0-1.0)
- `was_refused`: Boolean - Whether the system refused to answer
- `refusal_reason`: Text (Optional) - Reason for refusal if applicable
- `generated_at`: DateTime - Timestamp of response generation
- `processing_time_ms`: Integer - Time taken to generate the response

**Validation Rules**:
- If `was_refused` is false, `answer` must not be empty
- If `was_refused` is true, `refusal_reason` must not be empty
- `confidence_score` must be between 0.0 and 1.0
- `citations` must contain valid module/chapter references if `was_refused` is false

## Entity: Document Metadata

**Description**: Stores document-level metadata and relationships in the relational database

**Fields**:
- `document_id`: String (Primary Key) - Unique identifier for the document
- `module`: String - Module identifier
- `chapter`: String - Chapter identifier
- `title`: String - Document title
- `path`: String - File path relative to docs/ folder
- `word_count`: Integer - Total word count of the document
- `chunk_count`: Integer - Number of chunks created from this document
- `created_at`: DateTime - Timestamp of document processing
- `updated_at`: DateTime - Timestamp of last update

**Validation Rules**:
- `path` must be a valid path within the docs/ directory
- `word_count` and `chunk_count` must be non-negative integers
- `module` and `chapter` must match the book's structure

## Entity: User Session

**Description**: Tracks user sessions for conversation history and analytics

**Fields**:
- `session_id`: String (Primary Key) - Unique session identifier
- `user_id`: String (Optional) - User identifier if authenticated
- `start_time`: DateTime - When the session started
- `last_activity`: DateTime - Timestamp of last activity
- `query_count`: Integer - Number of queries in this session
- `ended_at`: DateTime (Optional) - When the session ended

**Validation Rules**:
- `query_count` must be a non-negative integer
- `ended_at` must be after `start_time` if present